<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>My Radio Station</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: white; /* Устанавливаем белый фон */
        }

        header, section {
            position: relative;
            z-index: 1; /* Поверх белого фона */
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            background-color: gray;
        }

        .active {
            background-color: green;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .table-container {
            flex: 1;
        }
    </style>
</head>
<body>
    <header>
        <h1>My Radio Station</h1>
        <p>Welcome to my online radio station! Enjoy the music.</p>
    </header>

    <section>
        <h2>Now Playing</h2>
        <p id="trackName">Loading track...</p>
        <progress id="progressBar" value="0" max="100"></progress>
        <p>Current time: <span id="currentTime">00:00</span></p>
        <audio id="audioPlayer" hidden>
            <source src="audio/program01.mp3" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </section>

    <div class="table-container">
        <h2>Program Schedule</h2>
        <table id="scheduleTable">
            <thead>
                <tr>
                    <th>Start Time</th>
                    <th>Program Title</th>
                    <th>File Name</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const trackName = document.getElementById('trackName');
        const progressBar = document.getElementById('progressBar');
        const currentTimeElement = document.getElementById('currentTime');
        const playlistUrl = 'playlist.m3u'; // Путь к вашему плейлисту
        const scheduleTableBody = document.querySelector('#scheduleTable tbody');

        let playlist = [];
        let currentTrack = 0;
        let trackStartTime = 0; // Время начала трека в секундах

        // Функция для парсинга плейлиста
        function parsePlaylist(data) {
            return data.split('\n')
                .filter(line => line && !line.startsWith('#'))
                .map(line => line.trim());
        }

        // Получаем длительность трека
        function getTrackDuration(track) {
            return new Promise((resolve) => {
                const tempAudio = new Audio(track);
                tempAudio.addEventListener('loadedmetadata', () => {
                    resolve(tempAudio.duration);
                });
            });
        }

        // Воспроизведение следующего трека
        async function playNextTrack() {
            if (playlist.length === 0) {
                console.error('Playlist is empty!');
                return;
            }

            const trackDuration = await getTrackDuration(playlist[currentTrack]);

            audioPlayer.src = playlist[currentTrack];
            trackName.textContent = `Now Playing: ${playlist[currentTrack]}`;
            audioPlayer.currentTime = trackStartTime; // Устанавливаем время начала воспроизведения
            audioPlayer.play();

            // Обновление прогресса и времени каждую секунду
            const interval = setInterval(() => {
                const currentTime = audioPlayer.currentTime;
                progressBar.value = (currentTime / trackDuration) * 100;
                currentTimeElement.textContent = formatTime(currentTime);
            }, 1000);

            // Событие завершения трека
            audioPlayer.addEventListener('ended', () => {
                clearInterval(interval);
                currentTrack = (currentTrack + 1) % playlist.length;
                trackStartTime = 0; // Следующий трек начинаем с начала
                playNextTrack();
            });

            updateScheduleStatus(); // Обновляем статус в расписании
        }

        // Форматирование времени
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        // Рассчитываем трек и время для начала воспроизведения
        function calculateStartPosition() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            // Файл 01 — полночь, файл 24 — 23:00
            currentTrack = hours; // Поскольку часы совпадают с индексами треков (0-23)
            if (currentTrack === 24) currentTrack = 0; // Переводим 24-й файл на 0-й

            const startTimeInMinutes = minutes + (seconds / 60); // Текущие минуты и секунды
            trackStartTime = startTimeInMinutes * 60; // Начало с текущих минут и секунд
        }

        // Обновление статуса в расписании
        function updateScheduleStatus() {
            const rows = scheduleTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const statusCell = row.querySelector('td:last-child .status-indicator');
                statusCell.classList.remove('active');
            });
            const activeRow = scheduleTableBody.children[currentTrack];
            if (activeRow) {
                const statusCell = activeRow.querySelector('td:last-child .status-indicator');
                statusCell.classList.add('active');
            }
        }

        // Создание расписания
        function createSchedule() {
            for (let i = 0; i < 24; i++) {
                const row = document.createElement('tr');
                const startTime = i === 0 ? '00:00' : `${i.toString().padStart(2, '0')}:00`;
                const programTitle = `Program ${i + 1}`;
                const fileName = `audio/program${i + 1}.mp3`;
                row.innerHTML = `
                    <td>${startTime}</td>
                    <td>${programTitle}</td>
                    <td>${fileName}</td>
                    <td><span class="status-indicator"></span></td>
                `;
                scheduleTableBody.appendChild(row);
            }
        }

        // Запуск воспроизведения с нужного момента
        function startPlayback() {
            calculateStartPosition();
            playNextTrack();
        }

        // Загрузка и парсинг плейлиста
        fetch(playlistUrl)
            .then(response => response.text())
            .then(data => {
                playlist = parsePlaylist(data);
                createSchedule(); // Создаем расписание
                if (playlist.length > 0) {
                    startPlayback();
                } else {
                    console.error('Playlist is empty after parsing.');
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке плейлиста:', error);
            });

    </script>
</body>
</html>
